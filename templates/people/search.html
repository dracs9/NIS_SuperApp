{% extends "base.html" %}
{% load static %}

{% block title %}Find People – NIS SuperApp{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-zinc-50 to-zinc-100 dark:from-zinc-900 dark:to-zinc-800">
  <!-- Header -->
  <div class="bg-white dark:bg-zinc-800 border-b border-zinc-200 dark:border-zinc-700">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">Find People</h1>
          <p class="text-zinc-600 dark:text-zinc-400 mt-1">Discover students by skills, interests, and activity</p>
        </div>
        <a href="{% url 'accounts:profile' %}" class="btn btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          My Profile
        </a>
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Filters Sidebar -->
      <div class="lg:col-span-1">
        <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-sm border border-zinc-200 dark:border-zinc-700 p-6 sticky top-6">
          <h3 class="font-semibold text-zinc-900 dark:text-zinc-100 mb-4">Filters</h3>

          <form method="get" x-data="{ open: false }" @submit="open = false">
            <!-- Search Query -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Search by name or username
              </label>
              <input
                type="text"
                name="q"
                value="{{ query }}"
                placeholder="e.g. John, @johndoe"
                class="w-full px-3 py-2 border border-zinc-300 dark:border-zinc-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-zinc-700 dark:text-zinc-100"
              >
            </div>

            <!-- Class Filter -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Class
              </label>
              <select name="class" class="w-full px-3 py-2 border border-zinc-300 dark:border-zinc-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-zinc-700 dark:text-zinc-100">
                <option value="">All Classes</option>
                {% for class_name in available_classes %}
                <option value="{{ class_name }}" {% if class_filter == class_name %}selected{% endif %}>
                  {{ class_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Shanyraq Filter -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Shanyraq
              </label>
              <select name="shanyraq" class="w-full px-3 py-2 border border-zinc-300 dark:border-zinc-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-zinc-700 dark:text-zinc-100">
                <option value="">All Shanyraqs</option>
                {% for shanyraq_name in available_shanyraqs %}
                <option value="{{ shanyraq_name }}" {% if shanyraq_filter == shanyraq_name %}selected{% endif %}>
                  {{ shanyraq_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Skills Filter -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Skills
              </label>
              <div class="space-y-2 max-h-48 overflow-y-auto">
                {% for skill in available_skills %}
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="skills"
                    value="{{ skill.id }}"
                    {% if skill.id|stringformat:"s" in skill_filters %}checked{% endif %}
                    class="rounded border-zinc-300 dark:border-zinc-600 text-emerald-600 focus:ring-emerald-500 dark:bg-zinc-700"
                  >
                  <span class="ml-2 text-sm text-zinc-700 dark:text-zinc-300">
                    {{ skill.name }}
                    <span class="text-xs text-zinc-500">({{ skill.get_category_display }})</span>
                  </span>
                </label>
                {% endfor %}
              </div>
            </div>

            <!-- Skill Level Filter -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Minimum Skill Level
              </label>
              <select name="level" class="w-full px-3 py-2 border border-zinc-300 dark:border-zinc-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-zinc-700 dark:text-zinc-100">
                <option value="">Any Level</option>
                {% for level_value, level_name in skill_levels %}
                <option value="{{ level_value }}" {% if level_filter == level_value %}selected{% endif %}>
                  {{ level_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- XP Filter -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Minimum XP
              </label>
              <input
                type="number"
                name="activity_min"
                value="{{ activity_min }}"
                placeholder="e.g. 100"
                class="w-full px-3 py-2 border border-zinc-300 dark:border-zinc-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-zinc-700 dark:text-zinc-100"
              >
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2">
              <button type="submit" class="flex-1 btn btn-primary">
                Apply Filters
              </button>
              <a href="{% url 'people:search' %}" class="btn btn-ghost">
                Clear
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Results -->
      <div class="lg:col-span-3">
        <!-- Active Filters -->
        {% if query or class_filter or shanyraq_filter or skill_filters or level_filter or activity_min %}
        <div class="mb-6">
          <div class="flex flex-wrap gap-2">
            <span class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Active filters:</span>

            {% if query %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200">
              Search: {{ query }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-emerald-600">
                ×
              </a>
            </span>
            {% endif %}

            {% if class_filter %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
              Class: {{ class_filter }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'class' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-blue-600">
                ×
              </a>
            </span>
            {% endif %}

            {% if shanyraq_filter %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">
              Shanyraq: {{ shanyraq_filter }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'shanyraq' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-purple-600">
                ×
              </a>
            </span>
            {% endif %}

            {% for skill_id in skill_filters %}
            {% for skill in available_skills %}
            {% if skill.id|stringformat:"s" == skill_id %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">
              Skill: {{ skill.name }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'skills' or value != skill_id %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-orange-600">
                ×
              </a>
            </span>
            {% endif %}
            {% endfor %}
            {% endfor %}

            {% if level_filter %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
              Level: {{ level_filter|title }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'level' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-indigo-600">
                ×
              </a>
            </span>
            {% endif %}

            {% if activity_min %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200">
              XP: ≥{{ activity_min }}
              <a href="?{% for key, value in request.GET.items %}{% if key != 'activity_min' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="ml-1 hover:text-pink-600">
                ×
              </a>
            </span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Results Count -->
        <div class="mb-6">
          <p class="text-zinc-600 dark:text-zinc-400">
            {% if page_obj.paginator.count == 0 %}
            No students found
            {% elif page_obj.paginator.count == 1 %}
            1 student found
            {% else %}
            {{ page_obj.paginator.count }} students found
            {% endif %}
          </p>
        </div>

        <!-- People Grid -->
        {% if page_obj %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {% for profile in page_obj %}
          <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-sm border border-zinc-200 dark:border-zinc-700 p-6 hover:shadow-md transition-shadow">
            <!-- Header -->
            <div class="flex items-start gap-4 mb-4">
              <img
                src="{% if profile.avatar %}{{ profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ profile.display_name|urlencode }}&background=10b981&color=fff{% endif %}"
                alt="{{ profile.display_name }}"
                class="w-16 h-16 rounded-full object-cover"
              >
              <div class="flex-1">
                <h3 class="font-semibold text-zinc-900 dark:text-zinc-100">{{ profile.display_name }}</h3>
                <p class="text-sm text-zinc-600 dark:text-zinc-400">@{{ profile.user.username }}</p>
                <div class="flex items-center gap-2 mt-1">
                  {% if profile.class_name %}
                  <span class="text-xs bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 px-2 py-1 rounded">
                    {{ profile.class_name }}
                  </span>
                  {% endif %}
                  {% if profile.shanyraq %}
                  <span class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-2 py-1 rounded">
                    {{ profile.shanyraq.name }}
                  </span>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Skills -->
            {% if profile.user.user_skills.all %}
            <div class="mb-4">
              <div class="flex flex-wrap gap-1">
                {% for user_skill in profile.user.user_skills.all|slice:":3" %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                  {% if user_skill.level == 'expert' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                  {% elif user_skill.level == 'advanced' %}bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200
                  {% elif user_skill.level == 'intermediate' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                  {% else %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% endif %}">
                  {{ user_skill.skill.name }}
                  {% if user_skill.level != 'beginner' %}
                  <span class="ml-1 opacity-75">({{ user_skill.get_level_display|slice:":1" }})</span>
                  {% endif %}
                </span>
                {% endfor %}
                {% if profile.user.user_skills.all|length > 3 %}
                <span class="text-xs text-zinc-500 dark:text-zinc-400">
                  +{{ profile.user.user_skills.all|length|add:"-3" }} more
                </span>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="text-center">
                <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{{ profile.user.season_xp }}</p>
                <p class="text-xs text-zinc-600 dark:text-zinc-400">XP</p>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ profile.shanyraq.season_sp|default:0 }}</p>
                <p class="text-xs text-zinc-600 dark:text-zinc-400">Shanyraq SP</p>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
              <a href="{% url 'accounts:profile_by_id' profile.user.id %}" class="flex-1 btn btn-primary text-center">
                View Profile
              </a>
              {% if user.is_moderator or user.is_shanyraq_leader %}
              <button class="btn btn-ghost" onclick="inviteToTeam({{ profile.user.id }})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                </svg>
              </button>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="mt-8 flex justify-center">
          <nav class="flex items-center gap-1">
            {% if page_obj.has_previous %}
            <a href="?{% for key, value in request.GET.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.previous_page_number }}" class="px-3 py-2 text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200">
              ← Previous
            </a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <span class="px-3 py-2 text-sm font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 rounded">
              {{ num }}
            </span>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
            <a href="?{% for key, value in request.GET.items %}{{ key }}={{ value }}&{% endfor %}page={{ num }}" class="px-3 py-2 text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200">
              {{ num }}
            </a>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?{% for key, value in request.GET.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.next_page_number }}" class="px-3 py-2 text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200">
              Next →
            </a>
            {% endif %}
          </nav>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
          <svg class="w-24 h-24 text-zinc-400 dark:text-zinc-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <h3 class="text-lg font-medium text-zinc-900 dark:text-zinc-100 mb-2">No students found</h3>
          <p class="text-zinc-600 dark:text-zinc-400 mb-6">Try adjusting your filters or search terms</p>
          <a href="{% url 'people:search' %}" class="btn btn-primary">
            Clear All Filters
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function inviteToTeam(userId) {
  // TODO: Implement team invitation modal
  alert('Team invitation feature coming soon!');
}
</script>
{% endblock %}