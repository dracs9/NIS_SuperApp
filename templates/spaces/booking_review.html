{% extends "base.html" %}

{% block title %}Review booking #{{ booking.pk }} – NIS SuperApp{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl">
  <nav class="mb-4 text-sm">
    <a href="{% url 'spaces:review_list' %}" class="text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200">← Pending review</a>
    <span class="mx-2 text-zinc-400">·</span>
    <a href="{% url 'spaces:booking_detail' booking.pk %}" class="text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200">Booking detail</a>
  </nav>

  <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">Review booking</h1>
  <p class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">Approve or reject with a comment</p>

  <div class="mt-6 rounded-2xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-700 dark:bg-zinc-800 overflow-hidden">
    <div class="border-b border-zinc-200 px-6 py-4 dark:border-zinc-700">
      <h2 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">{{ booking.space.name }}</h2>
      <p class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">
        {{ booking.start_time|date:"M j, Y g:i A" }} – {{ booking.end_time|time:"g:i A" }} · {{ booking.attendees_count }} attendees
      </p>
      <p class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">Requested by {{ booking.booked_by.email }}</p>
    </div>
    {% if booking.purpose %}
    <div class="border-b border-zinc-200 px-6 py-4 dark:border-zinc-700">
      <p class="whitespace-pre-wrap text-sm text-zinc-700 dark:text-zinc-300">{{ booking.purpose }}</p>
    </div>
    {% endif %}
    {% if conflicts %}
    <div class="border-b border-zinc-200 px-6 py-4 dark:border-zinc-700">
      <div class="rounded-xl border border-amber-200 bg-amber-50 p-4 dark:border-amber-900/50 dark:bg-amber-900/20">
        <h3 class="text-sm font-semibold text-amber-800 dark:text-amber-300">⚠️ Conflicts detected</h3>
        <p class="mt-1 text-sm text-amber-700 dark:text-amber-400">This booking overlaps with {{ conflicts|length }} existing booking(s). Approving may cause scheduling issues.</p>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="mt-8 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm dark:border-zinc-700 dark:bg-zinc-800">
    <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">Approve or reject</h3>
    <form method="post" action="" class="mt-4 space-y-4">
      {% csrf_token %}
      <div>
        <label for="id_comment" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Comment (required for rejection)</label>
        <textarea name="comment" id="id_comment" rows="3" class="input-field mt-1" placeholder="Optional for approve; required for reject">{{ form.comment.value|default:"" }}</textarea>
        {% if form.comment.errors %}<p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.comment.errors.0 }}</p>{% endif %}
      </div>
      <div class="flex flex-wrap gap-3">
        <button type="submit" name="action" value="approve" class="rounded-xl bg-emerald-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 dark:bg-emerald-500 dark:hover:bg-emerald-400">Approve</button>
        <button type="submit" name="action" value="reject" class="rounded-xl border border-red-300 bg-red-50 px-4 py-2.5 text-sm font-semibold text-red-800 hover:bg-red-100 dark:border-red-800 dark:bg-red-900/20 dark:text-red-300 dark:hover:bg-red-900/30">Reject</button>
        <a href="{% url 'spaces:booking_detail' booking.pk %}" class="rounded-xl border border-zinc-300 bg-white px-4 py-2.5 text-sm font-semibold text-zinc-700 hover:bg-zinc-50 dark:border-zinc-600 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">Cancel</a>
      </div>
    </form>
  </div>

  {% if approval_logs %}
  <div class="mt-8 rounded-2xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-700 dark:bg-zinc-800 overflow-hidden">
    <div class="border-b border-zinc-200 bg-zinc-50 px-4 py-3 dark:border-zinc-700 dark:bg-zinc-700/50">
      <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">Status history</h3>
    </div>
    <ul class="divide-y divide-zinc-200 dark:divide-zinc-700">
      {% for log in approval_logs %}
      <li class="px-4 py-3">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          {% if log.from_status %}<span class="font-medium text-zinc-900 dark:text-zinc-100">{{ log.from_status|title }}</span>
          <span class="text-zinc-400">→</span>{% endif %}
          <span class="font-medium text-zinc-900 dark:text-zinc-100">{{ log.to_status|title }}</span>
          <span class="text-zinc-500 dark:text-zinc-400">· {{ log.created_at|date:"M j, Y g:i A" }}</span>
          {% if log.changed_by %}<span class="text-zinc-500 dark:text-zinc-400">by {{ log.changed_by.email }}</span>{% endif %}
        </div>
        {% if log.comment %}<p class="mt-1 text-sm text-zinc-600 dark:text-zinc-400">{{ log.comment }}</p>{% endif %}
      </li>
      {% empty %}
      <li class="px-4 py-6 text-center text-sm text-zinc-500 dark:text-zinc-400">No history yet.</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>
{% endblock %}
