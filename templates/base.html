{% load static %}
{% load role_tags %}
<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth"
      x-data="appLayout()"
      x-init="initTheme()"
      :class="{ 'dark': isDark }">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}NIS SuperApp{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/design-system.css' %}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b',
            },
            secondary: {
              50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81',
            },
            accent: {
              purple: { 400: '#c084fc', 500: '#a855f7', 600: '#9333ea' },
              orange: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c' },
            },
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgb(0 0 0 / 0.07), 0 10px 20px -2px rgb(0 0 0 / 0.04)',
            'glow': '0 0 20px -5px rgb(16 185 129 / 0.3)',
          },
        },
      },
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('appLayout', () => ({
        sidebarOpen: false,
        mobileNavOpen: false,
        userDropdownOpen: false,
        isDark: false,
        themePreference: '{{ theme_preference|default:"system" }}',
        initTheme() {
          const stored = localStorage.getItem('theme');
          if (stored) this.themePreference = stored;
          this.applyTheme();
        },
        applyTheme() {
          const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          this.isDark = this.themePreference === 'dark' || (this.themePreference === 'system' && preferDark);
          document.documentElement.classList.toggle('dark', this.isDark);
        },
        setTheme(theme) {
          this.themePreference = theme;
          localStorage.setItem('theme', theme);
          this.applyTheme();
          try { if (typeof window.saveTheme === 'function') window.saveTheme(theme); } catch (e) {}
        },
      }));
    });
  </script>
  {% block extra_head %}{% endblock %}
</head>
<body class="h-full bg-zinc-50 text-zinc-900 antialiased dark:bg-zinc-900 dark:text-zinc-100">
  <div class="min-h-full flex">
    <!-- Desktop sidebar -->
    <aside class="hidden lg:flex lg:flex-shrink-0 lg:flex-col w-64 rounded-r-2xl border-r border-zinc-200 bg-white shadow-soft dark:border-zinc-700 dark:bg-zinc-800">
      <div class="flex flex-col flex-grow pt-5 pb-4 overflow-y-auto">
        <div class="flex items-center justify-between flex-shrink-0 px-4">
          <a href="{% url 'home' %}" class="text-xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-500 bg-clip-text text-transparent dark:from-emerald-400 dark:to-emerald-300">NIS SuperApp</a>
        </div>
        <nav class="mt-6 flex-1 px-2 space-y-1">
          <a href="{% url 'home' %}" class="group flex items-center gap-2 rounded-xl px-3 py-2.5 text-sm font-medium transition-all {% if section_name == 'Home' %}bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300{% else %}text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-100{% endif %}">Home</a>
          {% if user.is_authenticated %}
          <a href="{% url 'accounts:profile' %}" class="group flex items-center gap-2 rounded-xl px-3 py-2.5 text-sm font-medium transition-all {% if section_name == 'Profile' %}bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300{% else %}text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-100{% endif %}">Profile</a>
          {% if user.is_staff or user|has_role:"admin" %}
          <a href="/admin/" class="group flex items-center gap-2 rounded-xl px-3 py-2.5 text-sm font-medium text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-100">
            Admin
            <span class="rounded-full bg-amber-100 px-1.5 py-0.5 text-xs font-semibold text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">Staff</span>
          </a>
          {% endif %}
          {% endif %}
        </nav>
        <div class="flex-shrink-0 border-t border-zinc-200 p-4 dark:border-zinc-700">
          {% if user.is_authenticated %}
          <div class="relative">
            <button type="button" @click="userDropdownOpen = !userDropdownOpen" class="flex w-full items-center gap-3 rounded-xl p-2 text-left hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors">
              {% if user_profile.avatar %}
              <img src="{{ user_profile.avatar.url }}" alt="" class="h-9 w-9 rounded-full object-cover ring-2 ring-emerald-500/20">
              {% else %}
              <div class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 font-semibold dark:bg-emerald-900/50 dark:text-emerald-300">{{ user_profile.display_name|default:user.email|slice:":1"|upper }}</div>
              {% endif %}
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-zinc-900 truncate dark:text-zinc-100">{{ user_profile.display_name|default:user.email }}</p>
                <p class="text-xs text-zinc-500 truncate dark:text-zinc-400">{{ nis_points }} XP ¬∑ {{ shanyraq_points }} Qanat</p>
              </div>
              <svg class="h-5 w-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="userDropdownOpen" x-cloak @click.outside="userDropdownOpen = false"
                 x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                 class="absolute bottom-full left-0 right-0 mb-2 rounded-xl border border-zinc-200 bg-white py-1 shadow-lg dark:border-zinc-700 dark:bg-zinc-800">
              <a href="{% url 'accounts:profile' %}" class="block px-4 py-2 text-sm text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700">Profile</a>
              <button type="button" @click="setTheme(isDark ? 'light' : 'dark'); userDropdownOpen = false" class="block w-full px-4 py-2 text-left text-sm text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700"><span x-text="isDark ? 'Light' : 'Dark'"></span> mode</button>
              <a href="{% url 'account_logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20">Sign out</a>
            </div>
          </div>
          {% if user_rank %}
          <p class="mt-2 text-xs font-medium text-emerald-600 dark:text-emerald-400">{{ user_rank }} rank</p>
          {% endif %}
          {% else %}
          <div class="flex items-center gap-2">
            <a href="{% url 'account_login' %}" class="flex-1 rounded-xl bg-emerald-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 dark:bg-emerald-500 dark:hover:bg-emerald-400">Sign in</a>
            <a href="{% url 'account_signup' %}" class="flex-1 rounded-xl border border-zinc-300 bg-white px-3 py-2 text-center text-sm font-semibold text-zinc-700 hover:bg-zinc-50 dark:border-zinc-600 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">Sign up</a>
          </div>
          {% endif %}
        </div>
      </div>
    </aside>

    <!-- Mobile sidebar overlay -->
    <div x-show="sidebarOpen" x-cloak class="fixed inset-0 z-40 lg:hidden" aria-hidden="true">
      <div x-show="sidebarOpen" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-zinc-900/60 dark:bg-zinc-950/80" @click="sidebarOpen = false"></div>
      <div class="fixed inset-0 flex z-40">
        <div x-show="sidebarOpen" x-transition:enter="transition duration-300 transform" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition duration-200 transform" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" class="relative flex w-full max-w-xs flex-col rounded-r-2xl border-r border-zinc-200 bg-white shadow-xl dark:border-zinc-700 dark:bg-zinc-800">
          <div class="flex items-center justify-between px-4 pt-5">
            <a href="{% url 'home' %}" class="text-xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-500 bg-clip-text text-transparent">NIS SuperApp</a>
            <button type="button" class="rounded-lg p-2 text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-700" @click="sidebarOpen = false">
              <span class="sr-only">Close</span>
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <nav class="mt-6 flex-1 space-y-1 px-2">
            <a href="{% url 'home' %}" class="block rounded-xl px-3 py-2.5 text-base font-medium text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700">Home</a>
            {% if user.is_authenticated %}
            <a href="{% url 'accounts:profile' %}" class="block rounded-xl px-3 py-2.5 text-base font-medium text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700">Profile</a>
            {% if user.is_staff or user|has_role:"admin" %}
            <a href="/admin/" class="block rounded-xl px-3 py-2.5 text-base font-medium text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700">Admin <span class="text-amber-600 dark:text-amber-400 font-semibold">Staff</span></a>
            {% endif %}
            {% endif %}
          </nav>
          <div class="border-t border-zinc-200 p-4 dark:border-zinc-700">
            {% if user.is_authenticated %}
            <p class="text-sm font-semibold text-zinc-900 dark:text-zinc-100">{{ user_profile.display_name|default:user.email }}</p>
            <p class="text-xs text-zinc-500 dark:text-zinc-400">{{ nis_points }} XP ¬∑ {{ shanyraq_points }} Qanat</p>
            <a href="{% url 'account_logout' %}" class="mt-2 block text-sm font-medium text-red-600 dark:text-red-400">Sign out</a>
            {% else %}
            <a href="{% url 'account_login' %}" class="block rounded-xl bg-emerald-600 py-2.5 text-center text-sm font-semibold text-white">Sign in</a>
            <a href="{% url 'account_signup' %}" class="mt-2 block rounded-xl border border-zinc-300 py-2.5 text-center text-sm font-semibold text-zinc-700 dark:border-zinc-600 dark:text-zinc-300">Sign up</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="flex flex-1 flex-col min-w-0">
      <div class="lg:hidden flex items-center justify-between h-14 px-4 border-b border-zinc-200 bg-white dark:border-zinc-700 dark:bg-zinc-800">
        <button type="button" class="rounded-lg p-2 text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-700" @click="sidebarOpen = true">
          <span class="sr-only">Menu</span>
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <span class="text-lg font-bold text-zinc-900 dark:text-zinc-100">NIS SuperApp</span>
        <button type="button" @click="setTheme(isDark ? 'light' : 'dark')" class="rounded-lg p-2 text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-700" aria-label="Toggle theme">
          <span x-show="!isDark">üåô</span>
          <span x-show="isDark" x-cloak>‚òÄÔ∏è</span>
        </button>
      </div>

      <main class="flex-1 overflow-y-auto focus:outline-none">
        <div class="py-6 px-4 sm:px-6 lg:px-8">
          {% if messages %}
          <div class="mb-4 space-y-2">
            {% for message in messages %}
            <div class="rounded-xl border px-4 py-3 text-sm font-medium
              {% if message.tags == 'error' %}border-red-200 bg-red-50 text-red-800 dark:border-red-900/50 dark:bg-red-900/20 dark:text-red-300
              {% elif message.tags == 'success' %}border-emerald-200 bg-emerald-50 text-emerald-800 dark:border-emerald-900/50 dark:bg-emerald-900/20 dark:text-emerald-300
              {% elif message.tags == 'warning' %}border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-900/50 dark:bg-amber-900/20 dark:text-amber-300
              {% else %}border-indigo-200 bg-indigo-50 text-indigo-800 dark:border-indigo-900/50 dark:bg-indigo-900/20 dark:text-indigo-300{% endif %}" role="alert">
              {{ message }}
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% block content %}{% endblock %}
        </div>
      </main>

      <!-- Mobile bottom nav -->
      <nav class="lg:hidden fixed bottom-0 left-0 right-0 z-30 border-t border-zinc-200 bg-white safe-area-pb dark:border-zinc-700 dark:bg-zinc-800">
        <div class="flex h-16 justify-around items-center">
          <a href="{% url 'home' %}" class="flex flex-col items-center justify-center flex-1 py-2 text-xs {% if section_name == 'Home' %}font-semibold text-emerald-600 dark:text-emerald-400{% else %}text-zinc-500 dark:text-zinc-400{% endif %}">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            Home
          </a>
          {% if user.is_authenticated %}
          <a href="{% url 'accounts:profile' %}" class="flex flex-col items-center justify-center flex-1 py-2 text-xs {% if section_name == 'Profile' %}font-semibold text-emerald-600 dark:text-emerald-400{% else %}text-zinc-500 dark:text-zinc-400{% endif %}">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            Profile
          </a>
          {% if user.is_staff or user|has_role:"admin" %}
          <a href="/admin/" class="flex flex-col items-center justify-center flex-1 py-2 text-xs text-zinc-500 dark:text-zinc-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Admin
          </a>
          {% endif %}
          <a href="{% url 'account_logout' %}" class="flex flex-col items-center justify-center flex-1 py-2 text-xs text-zinc-500 dark:text-zinc-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            Sign out
          </a>
          {% else %}
          <a href="{% url 'account_login' %}" class="flex flex-col items-center justify-center flex-1 py-2 text-xs text-zinc-500 dark:text-zinc-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
            Sign in
          </a>
          {% endif %}
        </div>
      </nav>
      <div class="lg:hidden h-16"></div>
    </div>
  </div>
  <!-- Onboarding modal (first login) -->
  {% if user.is_authenticated and onboarding_needed %}
  <div x-data="{ open: true }" x-show="open" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
    <div class="fixed inset-0 bg-zinc-900/60 dark:bg-zinc-950/80 backdrop-blur-sm" @click="open = false"></div>
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="relative w-full max-w-md rounded-2xl border border-zinc-200 bg-white p-6 shadow-xl dark:border-zinc-700 dark:bg-zinc-800" @click.stop>
        <h2 class="text-xl font-bold text-zinc-900 dark:text-zinc-100">Complete your profile</h2>
        <p class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">Set your class, shanyraq, and avatar.</p>
        <form action="{% url 'accounts:onboarding_save' %}" method="post" enctype="multipart/form-data" class="mt-6 space-y-4">
          {% csrf_token %}
          <div>
            <label for="onboarding_class" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Class</label>
            <input type="text" name="class_name" id="onboarding_class" class="input-field mt-1" placeholder="e.g. 10A, 11B" maxlength="64">
          </div>
          <div>
            <label for="onboarding_shanyraq" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Shanyraq</label>
            <select name="shanyraq" id="onboarding_shanyraq" class="input-field mt-1">
              <option value="">‚Äî Select ‚Äî</option>
              {% for s in onboarding_shanyraq_list %}
              <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="onboarding_avatar" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Avatar (optional)</label>
            <input type="file" name="avatar" id="onboarding_avatar" accept="image/*" class="mt-1 block w-full text-sm text-zinc-500 file:mr-4 file:rounded-lg file:border-0 file:bg-emerald-50 file:px-4 file:py-2 file:text-sm file:font-medium file:text-emerald-700 dark:file:bg-emerald-900/30 dark:file:text-emerald-300">
          </div>
          <button type="submit" class="w-full rounded-xl bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 dark:bg-emerald-500 dark:hover:bg-emerald-400">Save and continue</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    window.saveTheme = function(theme) {
      var form = new FormData();
      form.append('theme', theme);
      form.append('csrfmiddlewaretoken', document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '');
      fetch('{% url "accounts:theme_save" %}', { method: 'POST', body: form, credentials: 'same-origin' });
    };
  </script>
  <style>[x-cloak]{display:none!important}</style>
  {% block extra_js %}{% endblock %}
</body>
</html>
